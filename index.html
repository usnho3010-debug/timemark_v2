<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Timemark Style Pro</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:10px}
input,button,label{width:100%;padding:6px;margin:4px 0;font-size:14px}
canvas{max-width:100%;margin-top:10px;border:1px solid #ccc}
.controls{background:#fff;padding:10px;border-radius:8px}
</style>
</head>

<body>

<h3>üìç Timemark Style Pro</h3>

<div class="controls">
<label>Th√™m ·∫£nh check-in </label>
<input type="file" id="imageInput" accept="image/*">
<label>Th√™m ·∫£nh logo </label>
<input type="file" id="logoInput" accept="image/*">

<label>Gi·ªù</label>
<input type="text" id="time">

<label>Ng√†y</label>
<input type="text" id="date">

<label>Th·ª©</label>
<input type="text" id="weekday">

<label>ƒê·ªãa ch·ªâ (X√£, Huy·ªán, T·ªânh)</label>
<input type="text" id="address">

<button onclick="setNow()">‚è± L·∫•y gi·ªù hi·ªán t·∫°i</button>
<button onclick="draw()">üñä T·∫°o watermark</button>
<button onclick="download()">‚¨áÔ∏è T·∫£i ·∫£nh</button>
</div>

<canvas id="c"></canvas>

<script>
const c = document.getElementById("c");
const ctx = c.getContext("2d");
let img = new Image();
let logo = new Image();

function fs(p){
  return Math.round(Math.min(c.width,c.height)*p);
}

function generateCode(len=12){
 const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
 return Array.from({length:len},()=>s[Math.random()*s.length|0]).join("");
}

function drawRoundedImage(ctx, img, x, y, w, h, r){
  ctx.save();
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
  ctx.clip();
  ctx.drawImage(img, x, y, w, h);
  ctx.restore();
}


imageInput.onchange = e=>{
 const r=new FileReader();
 r.onload=()=>img.src=r.result;
 r.readAsDataURL(e.target.files[0]);
};

logoInput.onchange = e=>{
 const r=new FileReader();
 r.onload=()=>logo.src=r.result;
 r.readAsDataURL(e.target.files[0]);
};

img.onload=()=>{
 c.width=img.width;
 c.height=img.height;
 ctx.drawImage(img,0,0);
};

function setNow(){
  const d = new Date();

  // Gi·ªù HH:mm (c√≥ s·ªë 0)
  time.value = d.toLocaleTimeString("vi-VN", {
    hour: '2-digit',
    minute: '2-digit'
  });

  // Ng√†y DD/MM/YYYY (c√≥ s·ªë 0)
  const day   = String(d.getDate()).padStart(2, '0');
  const month = String(d.getMonth() + 1).padStart(2, '0');
  const year  = d.getFullYear();

  date.value = `${day}/${month}/${year}`;

  // Th·ª© (vi·∫øt ch·ªØ)
  weekday.value = d.toLocaleDateString("vi-VN", { weekday: 'long' });
}


function draw(){
 if(!img.src) return alert("Ch∆∞a ch·ªçn ·∫£nh");
 ctx.drawImage(img,0,0);

 const pad=fs(0.04);

 /* ===== WATERMARK D·ªåC ===== */
 ctx.save();
 ctx.translate(c.width-fs(0.008),c.height/2);
 ctx.rotate(-Math.PI/2);
 ctx.fillStyle="rgba(255,255,255,0.9)";
 ctx.font=`${fs(0.018)}px Arial`;
 ctx.textAlign="center";
 ctx.fillText(` ${generateCode()}  Timemark Verified`,0,0);
 ctx.restore();

 /* ===== BRAND PH·∫¢I D∆Ø·ªöI ===== */
let yBrand = c.height - pad;
ctx.textAlign = "right";
ctx.font = `bold ${fs(0.028)}px Arial`;

/* ƒëo chi·ªÅu r·ªông ch·ªØ mark */
ctx.fillStyle = "#FFFFFF";
ctx.fillText("mark", c.width - pad, yBrand);
const wMark = ctx.measureText("mark").width;

/* v·∫Ω ch·ªØ Time li·ªÅn tr∆∞·ªõc mark */
ctx.fillStyle = "#FFC107";
ctx.fillText("Time", c.width - pad - wMark, yBrand);

/* d√≤ng ph·ª• */
ctx.font = `${fs(0.018)}px Arial`;
ctx.fillStyle = "rgba(255,255,255,0.5)";
ctx.fillText("100% Ch√¢n th·ª±c", c.width - pad, yBrand + fs(0.03));


 /* ===== C·ª§M TR√ÅI D∆Ø·ªöI ===== */
 ctx.textAlign="left";
 let leftX = pad;
 let y = c.height - pad - fs(0.09);

 /* LOGO ‚Äì ƒê·∫®Y L√äN CAO H∆†N */
if(logo.src){
  const lh = fs(0.085);
  const ratio = logo.width / logo.height;

  const logoW = lh * ratio;
  const logoX = leftX;
  const logoY = y - lh - fs(0.02);
  const radius = fs(0.012); // ƒë·ªô bo g√≥c m·ªÅm

  drawRoundedImage(
    ctx,
    logo,
    logoX,
    logoY,
    logoW,
    lh,
    radius
  );

  y += fs(0.02);
}


 /* GI·ªú | NG√ÄY ‚Äì TH·ª® */
ctx.font = `500 ${fs(0.045)}px "Inter","Helvetica Neue",Arial,sans-serif`;
 ctx.fillStyle="#FFFFFF";
 ctx.fillText(time.value,leftX,y+fs(0.015));

 const timeW = ctx.measureText(time.value).width;
 const lineX = leftX + timeW + fs(0.02);

 /* THANH K·∫∫ D·ªåC ‚Äì M√ÄU TR·∫ÆNG */
 ctx.strokeStyle="#FFFFFF";
 ctx.lineWidth=fs(0.004);
 ctx.beginPath();
 ctx.moveTo(lineX,y-fs(0.028));
 ctx.lineTo(lineX,y+fs(0.028));
 ctx.stroke();

ctx.font = `${fs(0.03)}px "Inter","Helvetica Neue",Arial,sans-serif`;
ctx.fillText(date.value, lineX + fs(0.015), y - fs(0.01));
ctx.fillText(weekday.value, lineX + fs(0.015), y + fs(0.03));


/* ƒê·ªäA CH·ªà */
y += fs(0.065);
ctx.font = `${fs(0.028)}px "Inter","Helvetica Neue",Arial,sans-serif`;
ctx.fillStyle = "rgba(255,255,255,0.9)";
ctx.fillText(address.value, leftX, y);

}
 //t·∫£i ·∫£nh v·ªÅ
function isIOS(){
  return /iPhone|iPad|iPod/i.test(navigator.userAgent);
}

function download(){
  if(!img.src) return alert("Ch∆∞a c√≥ ·∫£nh ƒë·ªÉ t·∫£i");

  const dataURL = c.toDataURL("image/png");

  if(isIOS()){
    // iOS: m·ªü ·∫£nh ra tab m·ªõi ƒë·ªÉ l∆∞u th·ªß c√¥ng
    const w = window.open();
    w.document.write(`
      <img src="${dataURL}" 
           style="width:100%;height:auto;display:block">
      <p style="text-align:center;font-family:sans-serif">
        Nh·∫•n gi·ªØ ·∫£nh ‚Üí L∆∞u v√†o ·∫¢nh
      </p>
    `);
  }else{
    // Android / PC
    const a = document.createElement("a");
    a.href = dataURL;
    a.download = "timemark.png";
    a.click();
  }
}

</script>
</body>
</html>
